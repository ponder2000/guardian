{{define "content"}}
<div class="mb-6">
    <a href="/licenses" class="text-sm text-indigo-600 hover:text-indigo-500">&larr; Back to Licenses</a>
    <h1 class="mt-2 text-2xl font-bold text-gray-900">Upload &amp; Analyze License</h1>
    <p class="mt-1 text-sm text-gray-500">Upload a license file to verify its signature and check which hardware configurations match.</p>
</div>

{{if .Error}}
<div class="mb-4 rounded-md bg-red-50 p-4">
    <p class="text-sm text-red-700">{{.Error}}</p>
</div>
{{end}}

<!-- Upload Form -->
<div class="bg-white shadow rounded-lg border border-gray-100 p-6 mb-6 max-w-2xl">
    <form method="POST" action="/licenses/upload" enctype="multipart/form-data" class="flex items-end gap-3">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <div class="flex-1">
            <label for="license_file" class="block text-sm font-medium text-gray-700">License File</label>
            <input type="file" name="license_file" id="license_file" required accept=".license,.lic,.txt"
                class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
        </div>
        <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors">
            Analyze
        </button>
    </form>
</div>

{{if .Decoded}}
<!-- Verification Result -->
<div class="mb-6 rounded-md {{if .Verified}}bg-green-50 border border-green-200{{else}}bg-yellow-50 border border-yellow-200{{end}} p-4">
    <div class="flex items-center gap-2">
        {{if .Verified}}
        <svg class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/></svg>
        <span class="text-sm font-semibold text-green-800">Signature verified</span>
        {{else}}
        <svg class="h-5 w-5 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>
        <span class="text-sm font-semibold text-yellow-800">{{.VerifyErr}}</span>
        {{end}}
    </div>
    {{if .SignerFP}}
    <p class="mt-1 text-xs text-gray-600 font-mono">Signer: {{.SignerFP}}</p>
    {{end}}
</div>

<!-- Decoded License Info -->
<div class="bg-white shadow rounded-lg border border-gray-100 p-6 mb-6">
    <h2 class="text-sm font-semibold text-gray-900 mb-4">Decoded License</h2>
    <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div>
            <dt class="text-sm font-medium text-gray-500">License ID</dt>
            <dd class="mt-1 text-sm text-gray-900 font-mono">{{.Decoded.LicenseID}}</dd>
        </div>
        <div>
            <dt class="text-sm font-medium text-gray-500">Customer</dt>
            <dd class="mt-1 text-sm text-gray-900">{{.Decoded.IssuedTo}}</dd>
        </div>
        <div>
            <dt class="text-sm font-medium text-gray-500">Version</dt>
            <dd class="mt-1 text-sm text-gray-900">{{.Decoded.Version}}</dd>
        </div>
        <div>
            <dt class="text-sm font-medium text-gray-500">Issued At</dt>
            <dd class="mt-1 text-sm text-gray-900">{{formatDateTime .Decoded.IssuedAt}}</dd>
        </div>
        <div>
            <dt class="text-sm font-medium text-gray-500">Expires At</dt>
            <dd class="mt-1 text-sm text-gray-900">{{formatDateTime .Decoded.ExpiresAt}}</dd>
        </div>
        <div>
            <dt class="text-sm font-medium text-gray-500">Match Threshold</dt>
            <dd class="mt-1 text-sm text-gray-900">{{.Decoded.Hardware.MatchThreshold}} of 5</dd>
        </div>
    </dl>

    {{if .Decoded.Modules}}
    <div class="mt-4 border-t border-gray-200 pt-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Modules</h3>
        <div class="space-y-2">
            {{range $name, $mod := .Decoded.Modules}}
            <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-900">{{$name}}</span>
                {{if $mod.Enabled}}
                <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700">Enabled</span>
                {{else}}
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">Disabled</span>
                {{end}}
                {{range $k, $v := $mod.Metadata}}
                <span class="inline-flex items-center rounded bg-gray-100 px-1.5 py-0.5 text-xs text-gray-600">{{$k}}: {{$v}}</span>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</div>

<!-- Hardware Match Results -->
{{if .Matches}}
<div class="bg-white shadow rounded-lg border border-gray-100 p-6">
    <h2 class="text-sm font-semibold text-gray-900 mb-4">Hardware Match Results</h2>
    <div class="overflow-hidden rounded-lg border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hardware Config</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Project</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Matched</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Result</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {{range .Matches}}
                <tr class="{{if .Pass}}bg-green-50{{end}}">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">{{.HardwareConfig.Label}}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{.HardwareConfig.ProjectName}}</td>
                    <td class="px-4 py-3 text-sm text-center text-gray-700">{{.Matched}} / {{.Total}}</td>
                    <td class="px-4 py-3 text-center">
                        {{if .Pass}}
                        <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-semibold text-green-800">PASS</span>
                        {{else}}
                        <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-semibold text-red-800">FAIL</span>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{end}}
{{end}}
{{end}}
