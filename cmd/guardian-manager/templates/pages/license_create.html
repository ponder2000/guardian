{{define "content"}}
<div class="mb-6">
    <a href="/licenses" class="text-sm text-indigo-600 hover:text-indigo-500">&larr; Back to Licenses</a>
    <h1 class="mt-2 text-2xl font-bold text-gray-900">Create License</h1>
    <p class="mt-1 text-sm text-gray-500">Generate a new hardware-bound signed license file.</p>
</div>

{{if .Error}}
<div class="mb-4 rounded-md bg-red-50 p-4">
    <p class="text-sm text-red-700">{{.Error}}</p>
</div>
{{end}}

<form method="POST" action="/licenses" class="max-w-2xl space-y-6">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

    <!-- Customer & Project -->
    <div class="bg-white shadow rounded-lg border border-gray-100 p-6 space-y-4">
        <h2 class="text-sm font-semibold text-gray-900">License Details</h2>

        <div>
            <label for="customer" class="block text-sm font-medium text-gray-700">Customer Name</label>
            <input type="text" name="customer" id="customer" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500"
                placeholder="ACME Corporation">
        </div>

        <div>
            <label for="project_id" class="block text-sm font-medium text-gray-700">Project</label>
            <select name="project_id" id="project_id" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500"
                onchange="loadHardware(this.value)">
                <option value="">Select a project...</option>
                {{range .Projects}}
                <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
            </select>
        </div>

        <div>
            <label for="hardware_config_id" class="block text-sm font-medium text-gray-700">Hardware Configuration</label>
            <select name="hardware_config_id" id="hardware_config_id" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500">
                <option value="">Select a project first...</option>
                {{range .Hardware}}
                <option value="{{.ID}}" data-project="{{.ProjectID}}">{{.Label}} ({{.ProjectName}})</option>
                {{end}}
            </select>
        </div>

        <div>
            <label for="key_pair_id" class="block text-sm font-medium text-gray-700">Signing Key</label>
            <select name="key_pair_id" id="key_pair_id" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500">
                {{range .Keys}}
                <option value="{{.ID}}">{{.Name}}{{if .IsDefault}} (default){{end}}</option>
                {{end}}
            </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="expires" class="block text-sm font-medium text-gray-700">Expires</label>
                <input type="date" name="expires" id="expires" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label for="match_threshold" class="block text-sm font-medium text-gray-700">Match Threshold</label>
                <select name="match_threshold" id="match_threshold"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="1">1 of 5</option>
                    <option value="2">2 of 5</option>
                    <option value="3" selected>3 of 5 (default)</option>
                    <option value="4">4 of 5</option>
                    <option value="5">5 of 5</option>
                </select>
            </div>
        </div>

        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
            <textarea name="notes" id="notes" rows="2"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border focus:border-indigo-500 focus:ring-indigo-500"
                placeholder="Internal notes about this license..."></textarea>
        </div>
    </div>

    <!-- Modules -->
    <div class="bg-white shadow rounded-lg border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-gray-900">Modules</h2>
            <button type="button" onclick="addModuleRow()"
                class="inline-flex items-center gap-1 rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-200 transition-colors">
                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                Add Module
            </button>
        </div>
        <p class="text-xs text-gray-500 mb-3">Define licensed modules with optional metadata key-value pairs.</p>
        <div id="modules-container">
            <div class="module-row grid grid-cols-12 gap-2 mb-2 items-end">
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500">Module Name</label>
                    <input type="text" name="module_name" placeholder="e.g. analytics"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-2 py-1.5 border">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs font-medium text-gray-500">Key</label>
                    <input type="text" name="module_key" placeholder="e.g. max_users"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-2 py-1.5 border">
                </div>
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500">Value</label>
                    <input type="text" name="module_value" placeholder="e.g. 100"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm px-2 py-1.5 border">
                </div>
                <div class="col-span-1">
                    <button type="button" onclick="this.closest('.module-row').remove()" class="text-red-400 hover:text-red-600 p-1">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex items-center gap-3">
        <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors">
            Create License
        </button>
        <a href="/licenses" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
    </div>
</form>

<script>
function addModuleRow() {
    var container = document.getElementById('modules-container');
    var row = document.createElement('div');
    row.className = 'module-row grid grid-cols-12 gap-2 mb-2 items-end';
    row.innerHTML = '<div class="col-span-4"><input type="text" name="module_name" placeholder="module name" class="block w-full rounded-md border-gray-300 shadow-sm text-sm px-2 py-1.5 border"></div>' +
        '<div class="col-span-3"><input type="text" name="module_key" placeholder="key" class="block w-full rounded-md border-gray-300 shadow-sm text-sm px-2 py-1.5 border"></div>' +
        '<div class="col-span-4"><input type="text" name="module_value" placeholder="value" class="block w-full rounded-md border-gray-300 shadow-sm text-sm px-2 py-1.5 border"></div>' +
        '<div class="col-span-1"><button type="button" onclick="this.closest(\'.module-row\').remove()" class="text-red-400 hover:text-red-600 p-1"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button></div>';
    container.appendChild(row);
}

function loadHardware(projectId) {
    var hwSelect = document.getElementById('hardware_config_id');
    if (!projectId) {
        hwSelect.innerHTML = '<option value="">Select a project first...</option>';
        return;
    }
    fetch('/licenses/hardware?project_id=' + projectId)
        .then(function(r) { return r.text(); })
        .then(function(html) {
            hwSelect.innerHTML = '<option value="">Select hardware...</option>' + html;
        });
}
</script>
{{end}}
